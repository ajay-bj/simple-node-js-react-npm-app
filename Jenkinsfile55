pipeline {
    agent any

    parameters {
        extendedChoice(
            name: 'COMPONENTS',
            type: 'PT_CHECKBOX',
            multiSelectDelimiter: ',',
            quoteValue: false,
            description: 'Select components to deploy',
            value: 'frontend,backend,database'
        )
    }

    stages {
        stage('Clean Workspace') {
            steps {
                // Remove the node_modules directory to avoid conflicts
                sh 'rm -rf node_modules'
            }
        }

        stage('Build') { 
            steps {
                // Install dependencies
                sh 'npm install' 
            }
        }
        
        stage('Test') {
            steps {
                sh './jenkins/scripts/test.sh'
            }
        }

        stage('Select Components to Deploy') {
            steps {
                script {
                    echo "Selected components: ${params.COMPONENTS}"
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def selectedComponents = params.COMPONENTS.split(',')

                    if (env.BRANCH_NAME == 'develop') {
                        echo "Deploying to Staging Environment..."
                        input message: 'Finished using the website in STAGING? (Click "Proceed" to continue)'
                        
                        if (selectedComponents.contains('frontend')) {
                            echo "Deploying Frontend to Staging..."
                            // Add frontend deployment steps
                        }

                        if (selectedComponents.contains('backend')) {
                            echo "Deploying Backend to Staging..."
                            // Add backend deployment steps
                        }

                        if (selectedComponents.contains('database')) {
                            echo "Deploying Database to Staging..."
                            // Add database deployment steps
                        }

                    } else if (env.BRANCH_NAME == 'master') {
                        echo "Deploying to Production Environment..."
                        sh './jenkins/scripts/deliver.sh'
                        input message: 'Deploy to Production? (Click "Proceed" to continue)'

                        if (selectedComponents.contains('frontend')) {
                            echo "Deploying Frontend to Production..."
                            // Add frontend production deployment steps
                        }

                        if (selectedComponents.contains('backend')) {
                            echo "Deploying Backend to Production..."
                            // Add backend production deployment steps
                        }

                        if (selectedComponents.contains('database')) {
                            echo "Deploying Database to Production..."
                            // Add database production deployment steps
                        }

                        sh './jenkins/scripts/kill.sh'
                        echo "branch: ${env.BRANCH_NAME} running in PRODUCTION"
                    } else {
                        echo "No deployment for branch: ${env.BRANCH_NAME}"
                    }
                }
            }
        }
    }
}
